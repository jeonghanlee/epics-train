Recipe for setting up tools
===========================

# Set environment variables and aliases for now
source ~/epics-train/settings.sh
# .. and for eternity
echo >>~/.bashrc source ~/epics-train/settings.sh

cd ~/epics-train/tools

# Disable firewall
sudo systemctl stop firewalld
sudo systemctl disable firewalld

# EPICS Base
sudo yum install readline-devel
wget https://www.epics.anl.gov/epics/download/base/base-7.0.1.1.tar.gz
tar vzxf base-7.0.1.1.tar.gz
rm base-7.0.1.1.tar.gz
cd base-7.0.1.1
make clean uninstall
make
cd ..

# EtherIP
git clone https://github.com/EPICSTools/ether_ip.git
cd ether_ip
make
cd ..

# Autosave
wget https://github.com/epics-modules/autosave/archive/R5-7-1.tar.gz
tar vzxf R5-7-1.tar.gz 
rm R5-7-1.tar.gz 
cp ether_ip/configure/RELEASE  autosave-R5-7-1/configure/
cd autosave-R5-7-1/
make
cd ..

# EPICS pvaPY Module
sudo yum install -y numpy
sudo yum install -y python-devel
sudo yum install -y boost-devel
sudo yum install -y boost-python

# The pvaPy with EPICS-CPP-4.6.0 lacks the latest pvaServer additions
#cd EPICS-CPP-4.6.0/pvaPy
#make configure EPICS_BASE=$EPICS_BASE EPICS4_DIR=$EPICS_BASE4
#make
#cd ../..

# Download and compile the lastest 
git clone https://github.com/epics-base/pvaPy.git
cd pvaPy
make configure EPICS_BASE=$EPICS_BASE EPICS4_DIR=$EPICS_BASE4
make


# Example V4 image and SNS neutron data similator
git clone https://github.com/kasemir/EPICSV4Sandbox.git
# Get the previous version that has byte[], not short[] for image data
git checkout d4f69b129a7c3d22769ba445abc535ef7b4199b3
(cd EPICSV4Sandbox/neutronsDemoServer; make)
(cd EPICSV4Sandbox/ntndarrayServer; make)


# Java
# Can't automate. Need to download JDK 8 (tar.gz, not the rpm) from
# http://www.oracle.com/technetwork/java/javase/downloads/index.html
tar vzxf ~/Downloads/jdk-8u*-linux-x64.tar.gz


# CSS
wget https://ics-web.sns.ornl.gov/css/nightly/basic-epics-4.5.0-linux.gtk.x86_64.zip
unzip basic-epics-4.5.0-linux.gtk.x86_64.zip
mv basic-epics-4.5.0 CSS
rm basic-epics-4.5.0-linux.gtk.x86_64.zip

# Add PyDev
REPO=http://ics-web.sns.ornl.gov/css/nightly/repo
P2="java -Declipse.p2.mirrors=false 
    -jar CSS/plugins/org.eclipse.equinox.launcher_*.jar 
    -application org.eclipse.equinox.p2.director "
# Look for installable modules:
#  $P2 -repository $REPO -list  |  fgrep pydev.feature.group
$P2 -installIU org.csstudio.sns.feature.pydev.feature.group -repository $REPO -destination CSS -tag "PyDev"

# CSS Workspace:
# When started for the first time with a new workspace,
# there can be a PyDev prompt to configure python:
# Choose automatic config.
# 
# Exit CSS in 'CS-Studio' perspective


# Standalone Display Builder Runtime
wget https://ics-web.sns.ornl.gov/css/display.builder/display-runtime-0.1-linux.gtk.x86_64.zip
unzip display-runtime-0.1-linux.gtk.x86_64.zip
rm display-runtime*zip
mv display-runtime* display-runtime


# VDCT
# .. has several issues.
# 1) VDCT can no longer parse the dbd for R3.15,
#    so the ether_ip/dbd/eipIoc.dbd as built with EPICS base 3.14.12.6
#    has been included in this repo.
# 2) Popup dialogs (New Record, Properties) appear blank
#    until selecting a different window, then VDTC again to force a redraw.
wget https://www.aps.anl.gov/epics/download/extensions/VisualDCT-dist-2.6.1274.zip
mkdir VisualDCT
cd VisualDCT
unzip ../VisualDCT-dist-2.6.1274.zip 
cd ..
rm VisualDCT-dist-2.6.1274.zip 


# EDM
cd ~/epics-train/tools
# Prepare EPICS 'extensions' directory
wget https://epics.anl.gov/download/extensions/extensionsTop_20120904.tar.gz
tar vzxf extensionsTop_20120904.tar.gz
.. configure extensions/configure/RELEASE

# Get EDM from https://epics.anl.gov/extensions/index.php,
# unpack into ~/epics-train/tools/extensions/src
# Get dependencies
sudo yum install libXt-devel
sudo yum install libXmu-devel
sudo yum install motif-devel
sudo yum install libXtst-devel
sudo yum install giflib-devel
sudo yum install xorg-x11-fonts-75dpi
sudo yum install xorg-x11-fonts-ISO8859-1-75dpi

cd ~/epics-train/tools/extensions/src/edm
make

cd setup
export EDMFILES=/home/training/epics-train/tools/extensions/src/edm/setup
export EDMOBJECTS=$EDMFILES
export EDMPVOBJECTS=$EDMFILES
export PATH=/home/training/epics-train/tools/extensions/bin/linux-x86_64:$PATH
edm -add /home/training/epics-train/tools/extensions/lib/linux-x86_64/libEdmBase.so 
edm -add /home/training/epics-train/tools/extensions/lib/linux-x86_64/lib57d79238-2924-420b-ba67-dfbecdf03fcd.so
edm -addpv /home/training/epics-train/tools/extensions/lib/linux-x86_64/libEpics.so 
edm -addpv /home/training/epics-train/tools/extensions/lib/linux-x86_64/libCalc.so 
edm -addpv /home/training/epics-train/tools/extensions/lib/linux-x86_64/libLoc.so 

cd /home/training/epics-train/tools
cp edm_fonts.list extensions/src/edm/setup/fonts.list


# C-Python support for CSS
sudo easy_install py4j

mkdir /tmp/s
cd /tmp/s
unzip ~/epics-train/tools/CSS/plugins/org.csstudio.display.builder.runtime_*.jar 
cd scripts/
sudo python setup.py install
cd
rm -rf /tmp/s



cd ~/epics-train/examples
make


# State before taking snapwhot of VM:
# CSS left in reset 'CS-Studio' perspective,
# no files added, no "Display Builder" samples installed,
# ~/.bash_history cleared
